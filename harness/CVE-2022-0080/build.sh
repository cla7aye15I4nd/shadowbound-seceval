#!/bin/bash

DIR=$(cd "$(dirname "$0")"; pwd)
if [ ! -d "$DIR/mruby" ]; then
  git clone https://github.com/mruby/mruby.git
fi

cd mruby
git reset --hard 28ccc664e5dcd3f9d55173e9afde77c4705a9ab6^

make clean
make \
  CC=$SHADOWBOUND/llvm-project/build/bin/clang \
  CXX=$SHADOWBOUND/llvm-project/build/bin/clang++ \
  CFLAGS="-g -fsanitize=overflow-defense -mllvm -odef-keep-going=1" \
  CXXFLAGS="-g -fsanitize=overflow-defense -mllvm -odef-keep-going=1" \
  LDFLAGS="-fsanitize=overflow-defense" -j`nproc`

# ./mruby/bin/mirb ./test.rb