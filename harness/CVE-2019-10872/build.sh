#!/bin/bash


if [ ! -d "poppler" ]; then
    git clone https://gitlab.freedesktop.org/poppler/poppler.git -b poppler-0.74.0
fi

pushd poppler

mkdir -p build

pushd build

CC=$SHADOWBOUND/llvm-project/build/bin/clang \
CXX=$SHADOWBOUND/llvm-project/build/bin/clang++ \
CFLAGS="-fsanitize=overflow-defense" \
CXXFLAGS="-fsanitize=overflow-defense" \
cmake .. \
-DBUILD_SHARED_LIBS=OFF \
-DFONT_CONFIGURATION=generic \
-DBUILD_GTK_TESTS=OFF \
-DBUILD_QT5_TESTS=OFF \
-DBUILD_CPP_TESTS=OFF \
-DENABLE_LIBPNG=ON \
-DENABLE_LIBTIFF=ON \
-DENABLE_LIBJPEG=ON \
-DENABLE_SPLASH=ON \
-DENABLE_UTILS=ON \
-DWITH_Cairo=ON \
-DENABLE_CMS=none \
-DENABLE_LIBCURL=OFF \
-DENABLE_GLIB=OFF \
-DENABLE_GOBJECT_INTROSPECTION=OFF \
-DENABLE_QT5=OFF \
-DENABLE_LIBCURL=OFF \
-DWITH_NSS3=OFF

make -j

popd
popd

# ./poppler/build/utils/pdftoppm -cropbox -mono poc