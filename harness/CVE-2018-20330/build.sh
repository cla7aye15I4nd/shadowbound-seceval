#!/bin/bash

DIR=$(cd "$(dirname "$0")"; pwd)
if [ ! -d $DIR/libjpeg-turbo ]; then
  git clone https://github.com/libjpeg-turbo/libjpeg-turbo.git
fi

cd libjpeg-turbo
git reset --hard 3d9c64e9f8aa1ee954d1d0bb3390fc894bb84da3^

if [ -d build ]; then
  rm -rf build
fi

mkdir -p build && cd build

CC=$SHADOWBOUND/llvm-project/build/bin/clang \
CXX=$SHADOWBOUND/llvm-project/build/bin/clang++ \
CFLAGS="-g -fsanitize=overflow-defense" \
CXXFLAGS="-g -fsanitize=overflow-defense" \
cmake .. 

make clean
make -j`nproc`
cd ../..

# ./libjpeg-turbo/build/tjbench LAND3.BMP 90
